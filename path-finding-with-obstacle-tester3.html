<html>
    <head>
        <script>

            const mapWidth = 10;
            const mapHeight = 10;

            const customMap =[
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"water","passable": false},{"type":"water","passable": false},{"type":"water","passable": false},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ],
            [
              {"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"},{"type":"plain"}
            ]
          ];          
           const blankMap = Array.from({ length: mapHeight }, () => 
                Array.from({ length: mapWidth }, () => ({ type: 'plain' }))
            );

            const map = blankMap.map((row, rowIndex) => 
                customMap[rowIndex] ? customMap[rowIndex] : row);


            function serializeMapJson() {
                const rows = document.getElementById('map').querySelectorAll('.row');

                const tiles = [...rows].map(
                    (row) => [...row.querySelectorAll('.tile')].map(
                        (tile) => ({
                            type: tile.getAttribute('data-type')
                        })
                    )
                );

                document.getElementById('map_json').value = `[\n${tiles.map( row => JSON.stringify(row)).join(",\n")}]`;
            }
        </script>
        <script src="map.js"></script>
        <script src="map-pathfinding.js"></script>
        <link rel="stylesheet" href="map.css" />
        <style>
            table td {
                border:1px solid #333;
                width:7em;
            }
        </style>
        <script>
            function isCoordsPassable(x,y) {
                const tile = getTile(x, y);
                if (tile.getAttribute('data-passable') === 'true') {
                    return true;
                }
                if (tile.getAttribute('data-passable') === 'false') {
                    return false;
                }
                if (tile.getAttribute('data-type') === 'water') {
                    return false;
                }
                return true;
            }
            
            function animateHighlightTile(element, params) {
                const {current, i, comment} = params;
                const tile = element;
                const timeout = i * (
                    document.querySelector('input#path-animation-speed').value 
                    ? parseInt(document.querySelector('input#path-animation-speed').value)
                    : 0
                );

                const [x,y] = current;

                document.querySelector('table tbody').innerHTML
                    += `<tr><td>${i+1}</td><td>${x}</td><td>${y}</td><td>${comment}</td></tr>`;

                dotTimeoutTasks.push(
                    setTimeout(
                        (
                        (tileToHighlight, currentToPlaceDot, DotToPlace) => () => {
                            placeDot(currentToPlaceDot, DotToPlace);
                            element.classList.add('highlight');
                        })(tile, current, (i + 1) + ""),
                        timeout
                    )
                );
            }
            function highlightTile(element) {
                element.classList.add('highlight');
            }
            function placeDot(coords, markerText) {
                const tile = getTile(...coords);
                const x = coords[0] % 1;
                const y = coords[1] % 1;
                tile.innerHTML += `<div class="tile-dot" style="top: calc(${y*100}% - 1.5px); left: calc(${x*100}% - 1.5px)" 
                title="${coords[0]},${coords[1]}">${markerText ?? '-'}</div>`;
            }
            
            function clearAllHighlights() {
                originTile = null;
                destinationTile = null;
                document.querySelectorAll('div.tile.highlight').forEach(
                    (tile) => tile.classList.remove('highlight')
                );
                dotTimeoutTasks.forEach(
                    (task) => clearTimeout(task)
                );
                dotTimeoutTasks = [];
                document.querySelector('table#coords-table tbody').innerHTML = '';
            }
        </script>
    </head>
    <body>
        <div class="path-count">0</div>
        <div>
            <input id="path-animation-speed" type="number" />

            <script>
            const input = document.getElementById("path-animation-speed");
            
            // Load saved value
            input.value = localStorage.getItem("pathAnimationSpeed") || "";

            // Save on change
            input.addEventListener("input", () => {
                localStorage.setItem("pathAnimationSpeed", input.value);
            });
            </script>
        </div>
        <div id="map">
        </div>
        <table id="coords-table">
            <thead>
                <th>#</th>
                <th>x</th>
                <th>y</th>
                <th>comment</th>
            </thead>
            <tbody>

            </tbody>
        </table>
        <script>
            renderMap(
              map,
              { 
                renderExtraAttributes: (tile, x, y) => {
                  return ' onMouseUp="togglePath(this, isCoordsPassable);" '; 
                }
              }
            );
        </script>
    </body>
</html>